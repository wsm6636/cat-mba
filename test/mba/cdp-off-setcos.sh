#!/bin/bash
function set_COS_All() {
           
    strCPS="$@"
    #echo $strCPS
    declare -a CPS
    IFS=' ' read -ra CPS <<<$strCPS
    NR_CPUS=8
#    NR_CPUS=16
    MSR_COS_BASE=0xC90
    for ((i=0;i<${NR_CPUS}; i+=1)); do
        echo -n "[P${i}] COS="
        COSi=$((${MSR_COS_BASE} + ${i}))
        MSR_COSi=0x`echo "obase=16 ;$COSi"|bc`
        rdmsr -p ${i} ${MSR_COSi}
        echo "rdmsr -p ${i} ${MSR_COSi}"
        echo -n "     --> "
        printf "%08x\n" ${CPS}
        echo "wrmsr -p ${i} 0x${MSR_COSi} ${CPS[${i}]}"
        sudo wrmsr -p ${i} ${MSR_COSi} ${CPS[${i}]}
    done
}



#11M
#set_COS_All 0x7ff 0x7ff 0x7ff 0x7ff 0x7ff 0x7ff 0x7ff 0x7ff
#10M
#set_COS_All 0x3ff 0x3ff 0x3ff 0x3ff 0x3ff 0x3ff 0x3ff 0x3ff
#9M
#set_COS_All 0x1ff 0x1ff 0x1ff 0x1ff 0x1ff 0x1ff 0x1ff 0x1ff
#8M
#set_COS_All 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff
#7M
#set_COS_All 0x7f 0x7f 0x7f 0x7f 0x7f 0x7f 0x7f 0x7f
#6M
#set_COS_All 0x3f 0x3f 0x3f 0x3f 0x3f 0x3f 0x3f 0x3f
#5M
#set_COS_All 0x1f 0x1f 0x1f 0x1f 0x1f 0x1f 0x1f 0x1f
#4M
#set_COS_All 0xf 0xf 0xf 0xf 0xf 0xf 0xf 0xf
#3M
#set_COS_All 0x7 0x7 0x7 0x7 0x7 0x7 0x7 0x7
#2M
#set_COS_All 0x3 0x3 0x3 0x3 0x3 0x3 0x3 0x3
1M
set_COS_All 0x1 0x1 0x1 0x1 0x1 0x1 0x1 0x1
